
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Writing Tests for Devices &#8212; ophyd-async 0.9.1.dev36+gb53064e1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3fefa004" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=f0f5424b"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/writing-tests-for-devices';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://blueskyproject.io/ophyd-async/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../_static/ophyd-favicon.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Implementing File Writing Detectors" href="implementing-detectors.html" />
    <link rel="prev" title="Implementing Devices" href="implementing-devices.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/ophyd-async-logo.svg" class="logo__image only-light" alt="ophyd-async 0.9.1.dev36+gb53064e1 documentation - Home"/>
    <img src="../_static/ophyd-async-logo.svg" class="logo__image only-dark pst-js-only" alt="ophyd-async 0.9.1.dev36+gb53064e1 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io">
    Bluesky Project
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/ophyd-async" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/ophyd-async" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io">
    Bluesky Project
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/ophyd-async" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/ophyd-async" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="using-devices.html">Using Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementing-devices.html">Implementing Devices</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Writing Tests for Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="implementing-detectors.html">Implementing File Writing Detectors</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Writing Tests for Devices</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="writing-tests-for-devices">
<h1>Writing Tests for Devices<a class="headerlink" href="#writing-tests-for-devices" title="Link to this heading">#</a></h1>
<p>In this tutorial we will explore how to write tests for ophyd-async Devices that do not require the real hardware. This allows us to catch bugs in our logic by inspecting what it would send to the hardware, and once it is working gives us confidence that it will stay working. Python provides some standard tools like <a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html#module-unittest.mock" title="Python 3.13"><span class="xref myst">mocking, patching</span></a> and <a class="reference external" href="https://docs.pytest.org/en/stable/reference/fixtures.html#fixtures" title="pytest 8.3.5">fixtures</a>, and ophyd-async provides some utility methods to help too.</p>
<p>There are two categories of test that will typically be written for a Device:</p>
<ul class="simple">
<li><p>Tests that call the bluesky verbs (like <code class="docutils literal notranslate"><span class="pre">set()</span></code> or <code class="docutils literal notranslate"><span class="pre">read()</span></code>) directly</p></li>
<li><p>Tests that execute a bluesky plan (like <code class="docutils literal notranslate"><span class="pre">bp.count()</span></code>) under a RunEngine</p></li>
</ul>
<p>The first category are generally for low level tests like checking a motor will pass the correct units up to the progress bar or that it times out if the move is too short. The second category is for higher level tests like checking a detector will produce the correct files when used in a standard plan. Both will be needed at some point, so this tutorial will cover how to write the tests and when to use them.</p>
<section id="tests-that-call-the-bluesky-verbs-directly">
<h2>Tests that call the bluesky verbs directly<a class="headerlink" href="#tests-that-call-the-bluesky-verbs-directly" title="Link to this heading">#</a></h2>
<p>If we need to add a feature to a particular Device, or fix a bug, and it only affects a single verb, then we will probably test the device outside the bluesky RunEngine, calling the verbs directly. This means we need to:</p>
<ul class="simple">
<li><p>Create the Device</p></li>
<li><p>Set some mock values for the Signals on it</p></li>
<li><p>Call the verb</p></li>
<li><p>Inspect the results</p></li>
<li><p>Possibly do some cleanup</p></li>
</ul>
<section id="create-a-fixture-and-set-signal-values">
<h3>Create a fixture and set signal values<a class="headerlink" href="#create-a-fixture-and-set-signal-values" title="Link to this heading">#</a></h3>
<p>We will be writing a test using the pytest framework which encourages fixtures to setup and teardown the Devices we wish to test. In this case we will create the <code class="docutils literal notranslate"><span class="pre">DemoMotor</span></code> from the previous tutorial:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mock_motor</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">init_devices</span><span class="p">(</span><span class="n">mock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">mock_motor</span> <span class="o">=</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoMotor</span><span class="p">(</span><span class="s2">&quot;BLxxI-MO-TABLE-01:X:&quot;</span><span class="p">)</span>
    <span class="n">set_mock_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="s2">&quot;mm&quot;</span><span class="p">)</span>
    <span class="n">set_mock_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">set_mock_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">mock_motor</span>
</pre></div>
</div>
<p>This will use <a class="reference internal" href="../_api/ophyd_async/ophyd_async.core.html#ophyd_async.core.init_devices" title="ophyd_async.core.init_devices"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">init_devices</span></code></a> to call <a class="reference internal" href="../_api/ophyd_async/ophyd_async.core.html#ophyd_async.core.Device.connect" title="ophyd_async.core.Device.connect"><code class="xref myst py py-meth docutils literal notranslate"><span class="pre">Device.connect</span></code></a> with <code class="docutils literal notranslate"><span class="pre">mock=True</span></code>. This will recursively replace the real connection to hardware with a mock that allows us to change the Signal’s value that our code will see and capture any attempts to set the value from our code. In this case we know our tests will expect <code class="docutils literal notranslate"><span class="pre">units=&quot;mm&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">precision=3</span></code>, so we use <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.set_mock_value" title="ophyd_async.testing.set_mock_value"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">set_mock_value</span></code></a> to those here.</p>
<p>If we had any cleanup to do, we would do that after the yield statement.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is an async fixture, and we will be using async tests, so we need to install and configure <a class="reference external" href="https://github.com/pytest-dev/pytest-asyncio">pytest-asyncio</a> in our projects’s <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[project.optional-dependencies]</span>
<span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;pytest-asyncio&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="c1"># other dependencies</span>
<span class="p">]</span>

<span class="k">[tool.pytest.ini_options]</span>
<span class="n">asyncio_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;auto&quot;</span>
<span class="c1"># other options</span>
</pre></div>
</div>
</div>
</section>
<section id="checking-the-output-of-verbs-in-tests">
<h3>Checking the output of verbs in tests<a class="headerlink" href="#checking-the-output-of-verbs-in-tests" title="Link to this heading">#</a></h3>
<p>Let’s test some verbs. We want to check that we can <code class="docutils literal notranslate"><span class="pre">read()</span></code> and <code class="docutils literal notranslate"><span class="pre">read_configuration()</span></code> on a <code class="docutils literal notranslate"><span class="pre">DemoMotor</span></code> while staged, and that we can still call them when unstaged:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_read_motor</span><span class="p">(</span><span class="n">mock_motor</span><span class="p">:</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoMotor</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">mock_motor</span><span class="o">.</span><span class="n">stage</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">assert_reading</span><span class="p">(</span>
        <span class="n">mock_motor</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;mock_motor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;alarm_severity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
    <span class="p">)</span>
    <span class="k">await</span> <span class="n">assert_configuration</span><span class="p">(</span>
        <span class="n">mock_motor</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;mock_motor-units&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;mm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">ANY</span><span class="p">,</span>
                <span class="s2">&quot;alarm_severity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;mock_motor-velocity&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">ANY</span><span class="p">,</span>
                <span class="s2">&quot;alarm_severity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="c1"># Check that changing the readback value changes the reading</span>
    <span class="n">set_mock_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">readback</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">assert_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">readback</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">assert_reading</span><span class="p">(</span>
        <span class="n">mock_motor</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;mock_motor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;alarm_severity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
    <span class="p">)</span>
    <span class="c1"># Check we can still read when not staged</span>
    <span class="k">await</span> <span class="n">mock_motor</span><span class="o">.</span><span class="n">unstage</span><span class="p">()</span>
    <span class="n">set_mock_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">readback</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">assert_reading</span><span class="p">(</span>
        <span class="n">mock_motor</span><span class="p">,</span>
        <span class="p">{</span><span class="s2">&quot;mock_motor&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">ANY</span><span class="p">,</span> <span class="s2">&quot;alarm_severity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}},</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>We write an <code class="docutils literal notranslate"><span class="pre">async</span></code> test method so we can <code class="docutils literal notranslate"><span class="pre">await</span></code> our calls to verbs. We include the fixture we defined earlier in the function arguments and pytest will automatically create it for us and pass it to the function call. We make use of the <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.assert_reading" title="ophyd_async.testing.assert_reading"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">assert_reading</span></code></a>, <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.assert_value" title="ophyd_async.testing.assert_value"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">assert_value</span></code></a> and <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.assert_configuration" title="ophyd_async.testing.assert_configuration"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">assert_configuration</span></code></a> helpers to check that our motor gives the right output, then use <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.set_mock_value" title="ophyd_async.testing.set_mock_value"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">set_mock_value</span></code></a> to change the value of the read only Signal before checking the verbs give the right output.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some of our tests produce timestamps, instead of checking their values we use <a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.ANY" title="Python 3.13"><code class="iref myst docutils literal notranslate"><span class="pre">unittest.mock.ANY</span></code></a> to say that the timestamp just has to be present to pass.</p>
</div>
</section>
</section>
<section id="checking-that-signals-were-changed">
<h2>Checking that signals were changed<a class="headerlink" href="#checking-that-signals-were-changed" title="Link to this heading">#</a></h2>
<p>Now let’s call some verbs and check that they do the right thing. We want to check that <code class="docutils literal notranslate"><span class="pre">stop()</span></code> triggers the <a class="reference internal" href="../_api/ophyd_async/ophyd_async.core.html#ophyd_async.core.SignalX" title="ophyd_async.core.SignalX"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">SignalX</span></code></a> <code class="docutils literal notranslate"><span class="pre">stop_</span></code>, waiting for it to complete:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_motor_stopped</span><span class="p">(</span><span class="n">mock_motor</span><span class="p">:</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoMotor</span><span class="p">):</span>
    <span class="c1"># Check it hasn&#39;t already been called</span>
    <span class="n">stop_mock</span> <span class="o">=</span> <span class="n">get_mock_put</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">stop_</span><span class="p">)</span>
    <span class="n">stop_mock</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
    <span class="c1"># Call stop and check it&#39;s called with the default value</span>
    <span class="k">await</span> <span class="n">mock_motor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">stop_mock</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># We can also track all the mock puts that have happened on the device</span>
    <span class="n">parent_mock</span> <span class="o">=</span> <span class="n">get_mock</span><span class="p">(</span><span class="n">mock_motor</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">mock_motor</span><span class="o">.</span><span class="n">velocity</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">parent_mock</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">call</span><span class="o">.</span><span class="n">stop_</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">call</span><span class="o">.</span><span class="n">velocity</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>This time we use <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.get_mock_put" title="ophyd_async.testing.get_mock_put"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">get_mock_put</span></code></a> to get a <a class="reference external" href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.Mock" title="Python 3.13"><code class="iref myst docutils literal notranslate"><span class="pre">unittest.mock.Mock</span></code></a> that will be called every time <code class="docutils literal notranslate"><span class="pre">stop_.trigger()</span></code> is called. We check it hasn’t been called, then call our method, then check it has been called with <code class="docutils literal notranslate"><span class="pre">None</span></code> (what a SignalX sends to tell the backend to put the value needed to trigger). We also show that we can call <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.get_mock" title="ophyd_async.testing.get_mock"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">get_mock</span></code></a> on the parent to see all of the mock calls that have been made on all it’s children, useful to check ordering.</p>
</section>
<section id="checking-for-watcher-updates">
<h2>Checking for watcher updates<a class="headerlink" href="#checking-for-watcher-updates" title="Link to this heading">#</a></h2>
<p>Now let’s pretend to be a progress bar and check that we get the right outputs. We want to check that <code class="docutils literal notranslate"><span class="pre">set()</span></code> will call any progress watchers with appropriate updates, and also terminate when the readback value reaches the correct value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_motor_moving_well</span><span class="p">(</span><span class="n">mock_motor</span><span class="p">:</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoMotor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Start it moving</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">mock_motor</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">0.55</span><span class="p">)</span>
    <span class="c1"># Watch for updates, and make sure the first update is the current position</span>
    <span class="n">watcher</span> <span class="o">=</span> <span class="n">StatusWatcher</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">watcher</span><span class="o">.</span><span class="n">wait_for_call</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mock_motor&quot;</span><span class="p">,</span>
        <span class="n">current</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">time_elapsed</span><span class="o">=</span><span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="mf">0.08</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">await</span> <span class="n">assert_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">setpoint</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">done</span>
    <span class="c1"># Wait a bit and give it an update, checking that the watcher is called with it</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">set_mock_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">readback</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">watcher</span><span class="o">.</span><span class="n">wait_for_call</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mock_motor&quot;</span><span class="p">,</span>
        <span class="n">current</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">time_elapsed</span><span class="o">=</span><span class="n">pytest</span><span class="o">.</span><span class="n">approx</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="mf">0.08</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Make it almost get there and check that it completes</span>
    <span class="n">set_mock_value</span><span class="p">(</span><span class="n">mock_motor</span><span class="o">.</span><span class="n">readback</span><span class="p">,</span> <span class="mf">0.5499999</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">wait_for_pending_wakeups</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">done</span>
    <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">success</span>
</pre></div>
</div>
<p>Here we call the verb, but don’t wait for it to complete (as that would wait forever). Instead we attach a <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.StatusWatcher" title="ophyd_async.testing.StatusWatcher"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">StatusWatcher</span></code></a> to the <a class="reference internal" href="../_api/ophyd_async/ophyd_async.core.html#ophyd_async.core.WatchableAsyncStatus" title="ophyd_async.core.WatchableAsyncStatus"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">WatchableAsyncStatus</span></code></a> that <code class="docutils literal notranslate"><span class="pre">set()</span></code> returns, and periodically call <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.set_mock_value" title="ophyd_async.testing.set_mock_value"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">set_mock_value</span></code></a> on the readback, checking that our watcher was called with the right values. When we give it a value that should make <code class="docutils literal notranslate"><span class="pre">set()</span></code> terminate, we call <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.wait_for_pending_wakeups" title="ophyd_async.testing.wait_for_pending_wakeups"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">wait_for_pending_wakeups</span></code></a> to make sure the background tasks get some time to finish correctly before checking the status completed successfully.</p>
</section>
<section id="other-test-utilities">
<h2>Other test utilities<a class="headerlink" href="#other-test-utilities" title="Link to this heading">#</a></h2>
<p>There are a few other things we may wish to do in tests:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.set_mock_values" title="ophyd_async.testing.set_mock_values"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">set_mock_values</span></code></a> if you want to set a series of mock values, with repeated checks at each value</p></li>
<li><p><a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.callback_on_mock_put" title="ophyd_async.testing.callback_on_mock_put"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">callback_on_mock_put</span></code></a> to allow setting a Signal to have side effects, like setting another Signal</p></li>
<li><p><a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.set_mock_put_proceeds" title="ophyd_async.testing.set_mock_put_proceeds"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">set_mock_put_proceeds</span></code></a> to block or unblock <code class="docutils literal notranslate"><span class="pre">Signal.set(...,</span> <span class="pre">wait=True)</span></code> from completing</p></li>
<li><p><a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.mock_puts_blocked" title="ophyd_async.testing.mock_puts_blocked"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">mock_puts_blocked</span></code></a> a context manager that blocks put proceeds at the start, and unblocks at the end</p></li>
</ul>
</section>
<section id="tests-that-execute-a-bluesky-plan">
<h2>Tests that execute a bluesky plan<a class="headerlink" href="#tests-that-execute-a-bluesky-plan" title="Link to this heading">#</a></h2>
<p>If we need to check that our Device performs correctly within a plan that calls multiple verbs, it is best to test it under an actual RunEngine. This allows you to check that when the verbs are called in the order that they are in the plan, the correct behavior occurs.</p>
<section id="create-a-runengine-in-a-fixture">
<span id="run-engine-fixture"></span><h3>Create a RunEngine in a fixture<a class="headerlink" href="#create-a-runengine-in-a-fixture" title="Link to this heading">#</a></h3>
<p>First you need to define a RunEngine that could be used in any test. If you don’t already have one in your project you could define one like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">RE</span><span class="p">():</span>
    <span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">(</span><span class="n">call_returns_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">RE</span>
    <span class="k">if</span> <span class="n">RE</span><span class="o">.</span><span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">):</span>
        <span class="n">RE</span><span class="o">.</span><span class="n">halt</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="run-a-plan-and-inspect-the-documents-it-produces">
<h3>Run a plan and inspect the documents it produces<a class="headerlink" href="#run-a-plan-and-inspect-the-documents-it-produces" title="Link to this heading">#</a></h3>
<p>Now you can run a plan, and check that it produces the correct bluesky documents. Let’s go back to the demo and test the <code class="docutils literal notranslate"><span class="pre">DemoPointDetector</span></code> in a <code class="docutils literal notranslate"><span class="pre">bp.count</span></code> plan:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">mock_point_detector</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">init_devices</span><span class="p">(</span><span class="n">mock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">mock_point_detector</span> <span class="o">=</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoPointDetector</span><span class="p">(</span><span class="s2">&quot;MOCK:DET:&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">mock_point_detector</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_point_detector_in_plan</span><span class="p">(</span>
    <span class="n">RE</span><span class="p">:</span> <span class="n">RunEngine</span><span class="p">,</span> <span class="n">mock_point_detector</span><span class="p">:</span> <span class="n">demo</span><span class="o">.</span><span class="n">DemoPointDetector</span>
<span class="p">):</span>
    <span class="c1"># Subscribe to new documents produce, putting them in a dict by type</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="n">docs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span>
    <span class="c1"># Set the channel values to a known value</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">mock_point_detector</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">set_mock_value</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
    <span class="c1"># Run the plan and assert the right docs are produced</span>
    <span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">count</span><span class="p">([</span><span class="n">mock_point_detector</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">assert_emitted</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">docs</span><span class="p">[</span><span class="s2">&quot;event&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;mock_point_detector-channel-1-value&quot;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span>
        <span class="s2">&quot;mock_point_detector-channel-2-value&quot;</span><span class="p">:</span> <span class="mi">102</span><span class="p">,</span>
        <span class="s2">&quot;mock_point_detector-channel-3-value&quot;</span><span class="p">:</span> <span class="mi">103</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Here we create a <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.defaultdict" title="Python 3.13"><code class="iref myst docutils literal notranslate"><span class="pre">collections.defaultdict</span></code></a> and put the RunEngine produced documents in it. Then we use <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.set_mock_value" title="ophyd_async.testing.set_mock_value"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">set_mock_value</span></code></a> to set the channels of the detector to some known values. Finally we run the plan and use <a class="reference internal" href="../_api/ophyd_async/ophyd_async.testing.html#ophyd_async.testing.assert_emitted" title="ophyd_async.testing.assert_emitted"><code class="xref myst py py-func docutils literal notranslate"><span class="pre">assert_emitted</span></code></a> to check the correct numbers of documents have been produced. We can also inspect individual documents for more details.</p>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>In this tutorial we have explored how to write tests for Devices without having the hardware available, by using connection in mock mode.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="implementing-devices.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Implementing Devices</p>
      </div>
    </a>
    <a class="right-next"
       href="implementing-detectors.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Implementing File Writing Detectors</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tests-that-call-the-bluesky-verbs-directly">Tests that call the bluesky verbs directly</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-fixture-and-set-signal-values">Create a fixture and set signal values</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-the-output-of-verbs-in-tests">Checking the output of verbs in tests</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-that-signals-were-changed">Checking that signals were changed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-for-watcher-updates">Checking for watcher updates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-test-utilities">Other test utilities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tests-that-execute-a-bluesky-plan">Tests that execute a bluesky plan</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-runengine-in-a-fixture">Create a RunEngine in a fixture</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-a-plan-and-inspect-the-documents-it-produces">Run a plan and inspect the documents it produces</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/bluesky/ophyd-async/edit/main/docs/tutorials/writing-tests-for-devices.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/writing-tests-for-devices.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>