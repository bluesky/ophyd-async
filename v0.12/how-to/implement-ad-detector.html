
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How to implement a Device for an EPICS areaDetector &#8212; ophyd-async 0.12 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3fefa004" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=3f949d3d"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'how-to/implement-ad-detector';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://blueskyproject.io/ophyd-async/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '0.12';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="../_static/ophyd-favicon.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How to interact with signals while implementing bluesky verbs" href="interact-with-signals.html" />
    <link rel="prev" title="How to derive one signal from others" href="derive-one-signal-from-others.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.12" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/ophyd-async-logo.svg" class="logo__image only-light" alt="ophyd-async 0.12 documentation - Home"/>
    <img src="../_static/ophyd-async-logo.svg" class="logo__image only-dark pst-js-only" alt="ophyd-async 0.12 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io">
    Bluesky Project
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/ophyd-async" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/ophyd-async" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference.html">
    Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io">
    Bluesky Project
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/ophyd-async" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/ophyd-async" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="choose-right-baseclass.html">How to choose the right base class when implementing a new Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">How to contribute to the project</a></li>
<li class="toctree-l1"><a class="reference internal" href="derive-one-signal-from-others.html">How to derive one signal from others</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">How to implement a Device for an EPICS areaDetector</a></li>
<li class="toctree-l1"><a class="reference internal" href="interact-with-signals.html">How to interact with signals while implementing bluesky verbs</a></li>
<li class="toctree-l1"><a class="reference internal" href="put-device-back.html">How to use settings to put devices back in their original state</a></li>
<li class="toctree-l1"><a class="reference internal" href="store-and-retrieve.html">How to store and retrieve device settings</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../how-to.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">How to implement a Device for an EPICS areaDetector</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="how-to-implement-a-device-for-an-epics-areadetector">
<h1>How to implement a Device for an EPICS areaDetector<a class="headerlink" href="#how-to-implement-a-device-for-an-epics-areadetector" title="Link to this heading">#</a></h1>
<p>This document will walk through the steps taken to implement an ophyd-async Device that talks to an EPICS areaDetector</p>
<section id="create-a-module-to-put-the-code-in">
<h2>Create a module to put the code in<a class="headerlink" href="#create-a-module-to-put-the-code-in" title="Link to this heading">#</a></h2>
<p>The first stage is to make a module in the <code class="docutils literal notranslate"><span class="pre">ophyd-async</span></code> repository to put the code in:</p>
<ul class="simple">
<li><p>If you haven’t already, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:bluesky/ophyd-async.git</span></code> and make a new branch to work in</p></li>
<li><p>Create a new directory under <code class="docutils literal notranslate"><span class="pre">src/ophyd_async/epics/</span></code> which is the lowercase version of the epics support module for the detector</p>
<ul>
<li><p>For example, for <a class="reference external" href="https://github.com/areaDetector/ADAravis"><code class="docutils literal notranslate"><span class="pre">ADAravis</span></code></a> make a directory <code class="docutils literal notranslate"><span class="pre">adaravis</span></code></p></li>
</ul>
</li>
<li><p>Make an empty <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> within that directory</p></li>
</ul>
</section>
<section id="add-an-io-class-for-the-pv-interface">
<h2>Add an IO class for the PV interface<a class="headerlink" href="#add-an-io-class-for-the-pv-interface" title="Link to this heading">#</a></h2>
<p>Now you need an IO class that subclasses <a class="reference internal" href="../_api/ophyd_async/ophyd_async.epics.adcore.html#ophyd_async.epics.adcore.ADBaseIO" title="ophyd_async.epics.adcore.ADBaseIO"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">adcore.ADBaseIO</span></code></a>. This should add the PVs that are detector driver specific that are required to setup triggering.</p>
<p>For example for ADAravis this is in the file <code class="docutils literal notranslate"><span class="pre">_aravis_io.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span> <span class="k">as</span> <span class="n">A</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">SignalRW</span><span class="p">,</span> <span class="n">StrictEnum</span><span class="p">,</span> <span class="n">SubsetEnum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.epics</span><span class="w"> </span><span class="kn">import</span> <span class="n">adcore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.epics.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">PvSuffix</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AravisTriggerMode</span><span class="p">(</span><span class="n">StrictEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GigEVision GenICAM standard TriggerMode.&quot;&quot;&quot;</span>

    <span class="n">ON</span> <span class="o">=</span> <span class="s2">&quot;On&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use TriggerSource to trigger each frame&quot;&quot;&quot;</span>

    <span class="n">OFF</span> <span class="o">=</span> <span class="s2">&quot;Off&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Just trigger as fast as you can&quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AravisTriggerSource</span><span class="p">(</span><span class="n">SubsetEnum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Which trigger source to use when TriggerMode=On.&quot;&quot;&quot;</span>

    <span class="n">LINE1</span> <span class="o">=</span> <span class="s2">&quot;Line1&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AravisDriverIO</span><span class="p">(</span><span class="n">adcore</span><span class="o">.</span><span class="n">ADBaseIO</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic Driver supporting all GiGE cameras.</span>

<span class="sd">    This mirrors the interface provided by ADAravis/db/aravisCamera.template.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">trigger_mode</span><span class="p">:</span> <span class="n">A</span><span class="p">[</span><span class="n">SignalRW</span><span class="p">[</span><span class="n">AravisTriggerMode</span><span class="p">],</span> <span class="n">PvSuffix</span><span class="o">.</span><span class="n">rbv</span><span class="p">(</span><span class="s2">&quot;TriggerMode&quot;</span><span class="p">)]</span>
    <span class="n">trigger_source</span><span class="p">:</span> <span class="n">A</span><span class="p">[</span><span class="n">SignalRW</span><span class="p">[</span><span class="n">AravisTriggerSource</span><span class="p">],</span> <span class="n">PvSuffix</span><span class="o">.</span><span class="n">rbv</span><span class="p">(</span><span class="s2">&quot;TriggerSource&quot;</span><span class="p">)]</span>
</pre></div>
</div>
</section>
<section id="add-a-controller-that-knows-how-to-setup-the-driver">
<h2>Add a Controller that knows how to setup the driver<a class="headerlink" href="#add-a-controller-that-knows-how-to-setup-the-driver" title="Link to this heading">#</a></h2>
<p>Now you need a class that subclasses <a class="reference internal" href="../_api/ophyd_async/ophyd_async.epics.adcore.html#ophyd_async.epics.adcore.ADBaseController" title="ophyd_async.epics.adcore.ADBaseController"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">adcore.ADBaseController</span></code></a>. This should implement at least:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">get_deadtime()</span></code> to give the amount of time required between triggers for a given exposure</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prepare()</span></code> to set the camera up for a given trigger mode, number of frames and exposure</p></li>
</ul>
<p>For example for ADAravis this is in the file <code class="docutils literal notranslate"><span class="pre">_aravis_controller.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">DetectorTrigger</span><span class="p">,</span> <span class="n">TriggerInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.epics</span><span class="w"> </span><span class="kn">import</span> <span class="n">adcore</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">._aravis_io</span><span class="w"> </span><span class="kn">import</span> <span class="n">AravisDriverIO</span><span class="p">,</span> <span class="n">AravisTriggerMode</span><span class="p">,</span> <span class="n">AravisTriggerSource</span>

<span class="c1"># The deadtime of an ADaravis controller varies depending on the exact model of camera.</span>
<span class="c1"># Ideally we would maximize performance by dynamically retrieving the deadtime at</span>
<span class="c1"># runtime. See https://github.com/bluesky/ophyd-async/issues/308</span>
<span class="n">_HIGHEST_POSSIBLE_DEADTIME</span> <span class="o">=</span> <span class="mf">1961e-6</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AravisController</span><span class="p">(</span><span class="n">adcore</span><span class="o">.</span><span class="n">ADBaseController</span><span class="p">[</span><span class="n">AravisDriverIO</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;`DetectorController` for an `AravisDriverIO`.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_deadtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_HIGHEST_POSSIBLE_DEADTIME</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_info</span><span class="p">:</span> <span class="n">TriggerInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exposure</span> <span class="o">:=</span> <span class="n">trigger_info</span><span class="o">.</span><span class="n">livetime</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">acquire_time</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trigger_info</span><span class="o">.</span><span class="n">trigger</span> <span class="ow">is</span> <span class="n">DetectorTrigger</span><span class="o">.</span><span class="n">INTERNAL</span><span class="p">:</span>
            <span class="c1"># Set trigger mode off to ignore the trigger source</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">trigger_mode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">AravisTriggerMode</span><span class="o">.</span><span class="n">OFF</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">trigger_info</span><span class="o">.</span><span class="n">trigger</span> <span class="ow">in</span> <span class="p">{</span>
            <span class="n">DetectorTrigger</span><span class="o">.</span><span class="n">CONSTANT_GATE</span><span class="p">,</span>
            <span class="n">DetectorTrigger</span><span class="o">.</span><span class="n">EDGE_TRIGGER</span><span class="p">,</span>
        <span class="p">}:</span>
            <span class="c1"># Trigger on the rising edge of Line1</span>
            <span class="c1"># trigger mode must be set first and on it&#39;s own!</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">trigger_mode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">AravisTriggerMode</span><span class="o">.</span><span class="n">ON</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">trigger_source</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">AravisTriggerSource</span><span class="o">.</span><span class="n">LINE1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ADAravis does not support </span><span class="si">{</span><span class="n">trigger_info</span><span class="o">.</span><span class="n">trigger</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trigger_info</span><span class="o">.</span><span class="n">total_number_of_exposures</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">image_mode</span> <span class="o">=</span> <span class="n">adcore</span><span class="o">.</span><span class="n">ADImageMode</span><span class="o">.</span><span class="n">CONTINUOUS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image_mode</span> <span class="o">=</span> <span class="n">adcore</span><span class="o">.</span><span class="n">ADImageMode</span><span class="o">.</span><span class="n">MULTIPLE</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">num_images</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">trigger_info</span><span class="o">.</span><span class="n">total_number_of_exposures</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">image_mode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">image_mode</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="add-a-detector-that-puts-it-all-together">
<h2>Add a Detector that puts it all together<a class="headerlink" href="#add-a-detector-that-puts-it-all-together" title="Link to this heading">#</a></h2>
<p>Now you need to make a <a class="reference internal" href="../_api/ophyd_async/ophyd_async.core.html#ophyd_async.core.StandardDetector" title="ophyd_async.core.StandardDetector"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">StandardDetector</span></code></a> subclass that uses your IO and Controller with the standard file IO and Writer classes that come with ADCore. The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method should take the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">prefix</span></code>: The PV prefix for the driver and plugins</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">path_provider</span></code>: A <a class="reference internal" href="../_api/ophyd_async/ophyd_async.core.html#ophyd_async.core.PathProvider" title="ophyd_async.core.PathProvider"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">PathProvider</span></code></a> that tells the detector where to write data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">drv_suffix</span></code>: A PV suffix for the driver, defaulting to <code class="docutils literal notranslate"><span class="pre">&quot;cam1:&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">writer_cls</span></code>: An <a class="reference internal" href="../_api/ophyd_async/ophyd_async.epics.adcore.html#ophyd_async.epics.adcore.ADWriter" title="ophyd_async.epics.adcore.ADWriter"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">adcore.ADWriter</span></code></a> class to instantiate, defaulting to <a class="reference internal" href="../_api/ophyd_async/ophyd_async.epics.adcore.html#ophyd_async.epics.adcore.ADHDFWriter" title="ophyd_async.epics.adcore.ADHDFWriter"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">adcore.ADHDFWriter</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileio_suffix</span></code>: An optional PV suffix for the fileio, if not given it will default to the writer class default</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>: An optional name for the device</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">config_sigs</span></code>: Optionally the signals to report as configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">plugins</span></code>: An optional mapping of {<code class="docutils literal notranslate"><span class="pre">name</span></code>: <a class="reference internal" href="../_api/ophyd_async/ophyd_async.epics.adcore.html#ophyd_async.epics.adcore.NDPluginBaseIO" title="ophyd_async.epics.adcore.NDPluginBaseIO"><code class="xref myst py py-class docutils literal notranslate"><span class="pre">adcore.NDPluginBaseIO</span></code></a>} for each additional plugin that might contribute data to the resulting file</p></li>
</ul>
<p>For example for ADAravis this is in the file <code class="docutils literal notranslate"><span class="pre">_aravis.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathProvider</span><span class="p">,</span> <span class="n">SignalR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.epics</span><span class="w"> </span><span class="kn">import</span> <span class="n">adcore</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">._aravis_controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">AravisController</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._aravis_io</span><span class="w"> </span><span class="kn">import</span> <span class="n">AravisDriverIO</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AravisDetector</span><span class="p">(</span><span class="n">adcore</span><span class="o">.</span><span class="n">AreaDetector</span><span class="p">[</span><span class="n">AravisController</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of an ADAravis Detector.</span>

<span class="sd">    The detector may be configured for an external trigger on a GPIO port,</span>
<span class="sd">    which must be done prior to preparing the detector</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">path_provider</span><span class="p">:</span> <span class="n">PathProvider</span><span class="p">,</span>
        <span class="n">drv_suffix</span><span class="o">=</span><span class="s2">&quot;cam1:&quot;</span><span class="p">,</span>
        <span class="n">writer_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">adcore</span><span class="o">.</span><span class="n">ADWriter</span><span class="p">]</span> <span class="o">=</span> <span class="n">adcore</span><span class="o">.</span><span class="n">ADHDFWriter</span><span class="p">,</span>
        <span class="n">fileio_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">config_sigs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">SignalR</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">plugins</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">adcore</span><span class="o">.</span><span class="n">NDPluginBaseIO</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">AravisDriverIO</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">drv_suffix</span><span class="p">)</span>
        <span class="n">controller</span> <span class="o">=</span> <span class="n">AravisController</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">writer_cls</span><span class="o">.</span><span class="n">with_io</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">path_provider</span><span class="p">,</span>
            <span class="n">dataset_source</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span>
            <span class="n">fileio_suffix</span><span class="o">=</span><span class="n">fileio_suffix</span><span class="p">,</span>
            <span class="n">plugins</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span>
            <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
            <span class="n">plugins</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">config_sigs</span><span class="o">=</span><span class="n">config_sigs</span><span class="p">,</span>
        <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="make-it-importable">
<h2>Make it importable<a class="headerlink" href="#make-it-importable" title="Link to this heading">#</a></h2>
<p>Now you should take all the classes you’ve made and add it to the top level <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> to declare the public interface for this module. Typically you should also include any Enum types you have made to support the IO.</p>
<p>For example for ADAravis this is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Support for the ADAravis areaDetector driver.</span>

<span class="sd">https://github.com/areaDetector/ADAravis</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">._aravis</span><span class="w"> </span><span class="kn">import</span> <span class="n">AravisDetector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._aravis_controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">AravisController</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">._aravis_io</span><span class="w"> </span><span class="kn">import</span> <span class="n">AravisDriverIO</span><span class="p">,</span> <span class="n">AravisTriggerMode</span><span class="p">,</span> <span class="n">AravisTriggerSource</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;AravisDetector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AravisController&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AravisDriverIO&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AravisTriggerMode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AravisTriggerSource&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
<section id="write-tests">
<h2>Write tests<a class="headerlink" href="#write-tests" title="Link to this heading">#</a></h2>
<p>TODO</p>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>You have now made a detector, and can import and create it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.epics</span><span class="w"> </span><span class="kn">import</span> <span class="n">adaravis</span><span class="p">,</span> <span class="n">adcore</span>


<span class="n">det</span> <span class="o">=</span> <span class="n">adaravis</span><span class="o">.</span><span class="n">AravisDetector</span><span class="p">(</span>
   <span class="s2">&quot;PREFIX:&quot;</span><span class="p">,</span> 
   <span class="n">path_provider</span><span class="p">,</span> 
   <span class="n">drv_suffix</span><span class="o">=</span><span class="s2">&quot;DRV:&quot;</span><span class="p">,</span> 
   <span class="n">writer_cls</span><span class="o">=</span><span class="n">adcore</span><span class="o">.</span><span class="n">ADHDFWriter</span><span class="p">,</span> 
   <span class="n">fileio_suffix</span><span class="o">=</span><span class="s2">&quot;HDF:&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="continuously-acquiring-detector">
<h2>Continuously acquiring detector<a class="headerlink" href="#continuously-acquiring-detector" title="Link to this heading">#</a></h2>
<p>In the event that you need to be able to collect data from a detector that is continuously acquiring, you should use the <code class="docutils literal notranslate"><span class="pre">ContAcqAreaDetector</span></code> class.
This uses the builtin <code class="docutils literal notranslate"><span class="pre">areaDetector</span></code> <a class="reference external" href="https://areadetector.github.io/areaDetector/ADCore/NDPluginCircularBuff.html">circular buffer plugin</a> to act as the acquisition start/stop replacement, while the detector runs continuously.</p>
<p>Your AD IOC will require at least one instance of this plugin to be configured, and the output of the plugin should be fed to the file writer of your choosing.
The expectation is that the detector is already acquiring in continuous mode with the expected exposure time prior to using an instance of <code class="docutils literal notranslate"><span class="pre">ContAcqAreaDetector</span></code>.</p>
<p>To instantiate a detector instance, import it and create it like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd_async.epics</span><span class="w"> </span><span class="kn">import</span> <span class="n">adcore</span>

<span class="n">det</span> <span class="o">=</span> <span class="n">adcore</span><span class="o">.</span><span class="n">ContAcqAreaDetector</span><span class="p">(</span>
   <span class="s2">&quot;PREFIX:&quot;</span><span class="p">,</span> 
   <span class="n">path_provider</span><span class="p">,</span> 
   <span class="n">drv_cls</span><span class="o">=</span><span class="n">adcore</span><span class="o">.</span><span class="n">ADBaseIO</span><span class="p">,</span>
   <span class="n">drv_suffix</span><span class="o">=</span><span class="s2">&quot;DRV:&quot;</span><span class="p">,</span> 
   <span class="n">cb_suffix</span><span class="o">=</span><span class="s2">&quot;CB:&quot;</span><span class="p">,</span>
   <span class="n">writer_cls</span><span class="o">=</span><span class="n">adcore</span><span class="o">.</span><span class="n">ADHDFWriter</span><span class="p">,</span> 
   <span class="n">fileio_suffix</span><span class="o">=</span><span class="s2">&quot;HDF:&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that typically the only changes from a typical detector are the additional <code class="docutils literal notranslate"><span class="pre">cb_suffix</span></code> kwarg, which is used to identify the prefix to use when instantiating the circular buffer (CB) plugin instance, and the <code class="docutils literal notranslate"><span class="pre">drv_cls</span></code> kwarg, which allows you to specify the driver to use, with the default being the <code class="docutils literal notranslate"><span class="pre">ADBaseIO</span></code> class.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="derive-one-signal-from-others.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">How to derive one signal from others</p>
      </div>
    </a>
    <a class="right-next"
       href="interact-with-signals.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How to interact with signals while implementing bluesky verbs</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-module-to-put-the-code-in">Create a module to put the code in</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-an-io-class-for-the-pv-interface">Add an IO class for the PV interface</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-a-controller-that-knows-how-to-setup-the-driver">Add a Controller that knows how to setup the driver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-a-detector-that-puts-it-all-together">Add a Detector that puts it all together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-it-importable">Make it importable</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#write-tests">Write tests</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#continuously-acquiring-detector">Continuously acquiring detector</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/bluesky/ophyd-async/edit/0.12/docs/how-to/implement-ad-detector.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/how-to/implement-ad-detector.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>